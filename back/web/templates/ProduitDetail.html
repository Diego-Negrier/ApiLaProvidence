{% load static %}
{% extends 'base.html' %}
{% block title %}{{ produit.nom }} - Détail produit{% endblock %}
{% block content %}

  <a href="{% url 'produits:liste' %}">← Retour à la liste</a>

  <div class="container" style="margin-top:1rem;">
    <div class="cover">
      {% if produit.image_principale %}
        <img src="{{ produit.image_principale.url }}" alt="{{ produit.nom }}">
      {% else %}
        <div style="height:360px;display:flex;align-items:center;justify-content:center;color:#aaa;">Pas d'image</div>
      {% endif %}

      <div class="thumbs">
        {% for img in images_additionnelles %}
          <img src="{{ img.image.url }}" alt="{{ img.legende }}">
        {% endfor %}
      </div>

      {% if produit.qr_code %}
        <div class="qr">
          <strong>QR Code :</strong><br>
          <img src="{{ produit.qr_code.url }}" alt="QR {{ produit.nom }}" style="width:140px;border-radius:6px;">
        </div>
      {% endif %}
    </div>

    <div>
      <h1>{{ produit.nom }}</h1>
      <div class="meta">{{ produit.arborescence_complete }} • Réf: {{ produit.numero_unique }}</div>

      <div class="badges">
        {% if produit.est_bio %}<span class="badge">Bio</span>{% endif %}
        {% if produit.est_local %}<span class="badge">Local</span>{% endif %}
        {% if produit.est_nouveaute %}<span class="badge">Nouveauté</span>{% endif %}
        {% if produit.est_en_rupture %}
          <span class="badge" style="background:#ffdede;color:#a00;">Rupture</span>
        {% endif %}
        <span class="badge">Stock: {{ produit.stock_actuel }}</span>
      </div>

      <div style="margin-top: .6rem;">
        {% if prix_promo_ttc %}
          <span class="price">{{ prix_promo_ttc|floatformat:2 }}€ TTC</span>
          <span class="old-price">{{ prix_ttc|floatformat:2 }}€</span>
          {% if economie %}
            <div style="color:#4a7; margin-top:.4rem;">Économie: {{ economie|floatformat:2 }}€</div>
          {% endif %}
        {% else %}
          <div class="price">{{ prix_ttc|floatformat:2 }}€ TTC</div>
        {% endif %}
      </div>

      <div class="actions">
        {% if not produit.est_en_rupture %}
          <form method="post" action="#">
            {% csrf_token %}
            <button type="submit">Ajouter au panier</button>
          </form>
        {% else %}
          <button class="secondary" disabled>Indisponible</button>
        {% endif %}
        <a href="{{ produit.get_admin_url }}"><button class="secondary">Éditer (admin)</button></a>
      </div>

      <div class="section">
        <h3>Description</h3>
        <p>{{ produit.description|default:"Aucune description fournie." }}</p>
      </div>

      <div class="section">
        <h3>Caractéristiques</h3>
        <ul>
          {% for desc in descripteurs %}
            <li>
              <strong>{{ desc.get_label }}</strong> :
              <span>{{ desc.valeur }}</span>
            </li>
          {% empty %}
            <li>Aucun descripteur.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="section">
        <h3>Informations supplémentaires</h3>
        <p>Origine : <strong>{{ produit.origine|default:"Non renseignée" }}</strong></p>
        <p>Fournisseur : <strong>{% if produit.fournisseur %}{{ produit.fournisseur.nom }}{% else %}—{% endif %}</strong></p>
        <p>Unité de mesure : <strong>{{ produit.unite_mesure }}</strong></p>
        <p>Dernière modification : <strong>{{ produit.date_modification|date:"d/m/Y H:i" }}</strong></p>
      </div>

      <div class="section">
        <h3>Labels & logos</h3>
        <div class="label">
          {% for l in labels %}
            <div style="display:flex;align-items:center;gap:.5rem;margin-right:1rem;">
              <img src="{{ l.image.url }}" alt="{{ l.nom }}" style="width:48px;height:48px;object-fit:contain;border-radius:6px;">
              <div>
                <div style="font-weight:700;">{{ l.nom }}</div>
                <div style="font-size:.9rem;color:#666;">{{ l.description|truncatechars:80 }}</div>
              </div>
            </div>
          {% empty %}
            <p>Aucun label.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
